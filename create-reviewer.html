<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelpMarq - Create Reviewer Profile</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Create Reviewer Profile</h1>
                <p class="tagline">Set up your profile to start reviewing</p>
            </div>
            
            <form id="reviewerProfileForm" class="form">
                <div class="form-group">
                    <label for="username">Display Name *</label>
                    <input 
                        type="text" 
                        id="username" 
                        placeholder="e.g., Sarah Martinez"
                        required
                        minlength="3"
                        maxlength="50"
                    >
                </div>

                <div class="form-group">
                    <label for="expertise">Primary Expertise *</label>
                    <select id="expertise" required>
                        <option value="">Select your expertise...</option>
                        <option value="UI/UX Design">UI/UX Design</option>
                        <option value="Web Development">Web Development</option>
                        <option value="Mobile Development">Mobile Development</option>
                        <option value="Graphic Design">Graphic Design</option>
                        <option value="Product Management">Product Management</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Copywriting">Copywriting</option>
                        <option value="Business Strategy">Business Strategy</option>
                        <option value="Data Analysis">Data Analysis</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="experience">Years of Experience *</label>
                    <select id="experience" required>
                        <option value="">Select experience...</option>
                        <option value="0-1">Less than 1 year</option>
                        <option value="1-3">1-3 years</option>
                        <option value="3-5">3-5 years</option>
                        <option value="5-10">5-10 years</option>
                        <option value="10+">10+ years</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="portfolio">Portfolio / LinkedIn URL (Optional)</label>
                    <input 
                        type="url" 
                        id="portfolio" 
                        placeholder="https://..."
                    >
                </div>

                <div class="form-group">
                    <label for="bio">About You *</label>
                    <textarea 
                        id="bio" 
                        rows="4" 
                        placeholder="Tell us about your background (minimum 50 characters)..."
                        required
                        minlength="50"
                        maxlength="500"
                    ></textarea>
                    <small id="bioCounter">0 / 50 characters</small>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">Create Reviewer Profile</button>
            </form>

            <div id="message" class="message"></div>
        </div>
    </div>

    <script type="module">
        import { authClient, getCurrentUser } from './lib/auth.js';

        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api'
            : 'https://helpmarq-backend.onrender.com/api';
        
        window.addEventListener('load', async () => {
            console.log('=== REVIEWER CREATION PAGE LOADED ===');
            
            // Check authentication
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            console.log('✓ User authenticated:', user.id);

            // Bio counter
            const bioField = document.getElementById('bio');
            const bioCounter = document.getElementById('bioCounter');
            
            bioField.addEventListener('input', () => {
                const length = bioField.value.length;
                bioCounter.textContent = `${length} / 50 characters`;
                bioCounter.style.color = length >= 50 ? 'green' : 'red';
            });

            // Form submission
            const form = document.getElementById('reviewerProfileForm');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('=== FORM SUBMISSION STARTED ===');
                
                const submitBtn = document.getElementById('submitBtn');
                const message = document.getElementById('message');
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating Profile...';
                message.style.display = 'none';
                
                try {
                    const username = document.getElementById('username').value.trim();
                    const expertise = document.getElementById('expertise').value;
                    const experience = document.getElementById('experience').value;
                    const portfolio = document.getElementById('portfolio').value.trim();
                    const bio = document.getElementById('bio').value.trim();
                    
                    // Frontend validation
                    if (!username || username.length < 3) {
                        throw new Error('Display name must be at least 3 characters');
                    }
                    
                    if (!expertise) {
                        throw new Error('Please select your expertise');
                    }
                    
                    if (!experience) {
                        throw new Error('Please select your experience level');
                    }
                    
                    if (!bio || bio.length < 50) {
                        throw new Error('Bio must be at least 50 characters');
                    }
                    
                    console.log('✓ Frontend validation passed');
                    
                    // Get session token
                    const session = await authClient.getSession();
                    if (!session) {
                        throw new Error('Session expired. Please log in again.');
                    }
                    
                    const formData = {
                        username,
                        email: user.email,
                        expertise,
                        experience,
                        portfolio: portfolio || '',
                        bio
                    };
                    
                    console.log('Sending to server:', formData);
                    
                    const response = await fetch(`${API_URL}/auth/create-reviewer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.session.token}`
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || !result.success) {
                        throw new Error(result.error || `Server error: ${response.status}`);
                    }
                    
                    // Success!
                    console.log('=== SUCCESS ===');
                    message.textContent = '✅ Profile created! Redirecting...';
                    message.className = 'message success';
                    message.style.display = 'block';
                    
                    localStorage.setItem('userRole', 'reviewer');
                    sessionStorage.setItem('roleJustSelected', 'true');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                    
                } catch (error) {
                    console.error('=== ERROR ===', error);
                    
                    message.textContent = '❌ ' + error.message;
                    message.className = 'message error';
                    message.style.display = 'block';
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Reviewer Profile';
                }
            });
        });
    </script>
</body>
</html>