<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Role - HelpMarq</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card role-select-card">
            <div class="auth-header">
                <h1>Welcome to HelpMarq!</h1>
                <p class="tagline">Choose how you want to get started</p>
            </div>

            <div class="role-options">
                <div class="role-card" id="ownerCard">
                    <div class="role-icon">üìä</div>
                    <h3>Project Owner</h3>
                    <p>Upload projects and get expert feedback</p>
                    <button class="btn-primary">I'm a Project Owner</button>
                </div>

                <div class="role-card" id="reviewerCard">
                    <div class="role-icon">‚≠ê</div>
                    <h3>Reviewer</h3>
                    <p>Review projects and earn XP</p>
                    <button class="btn-primary">I'm a Reviewer</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getCurrentUser } from './lib/auth.js';

        window.addEventListener('load', async () => {
            console.log('=== ROLE SELECT PAGE LOADED ===');
            
            const user = await getCurrentUser();
            if (!user) {
                console.log('No user - redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('‚úì User authenticated:', user.email);

            const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000/api'
                : 'https://helpmarq-backend.onrender.com/api';

            // ‚úÖ FIX: Better role checking with retry logic
            console.log('üîç Checking if user already has a role...');
            
            let roleCheckAttempts = 0;
            const maxAttempts = 3;
            
            while (roleCheckAttempts < maxAttempts) {
                try {
                    roleCheckAttempts++;
                    console.log(`Role check attempt ${roleCheckAttempts}/${maxAttempts}`);
                    
                    const response = await fetch(`${API_URL}/user/me`, {
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Role check result:', result);
                        
                        if (result.success && result.role) {
                            console.log('‚úì User already has role:', result.role);
                            localStorage.setItem('userRole', result.role);
                            
                            if (result.role === 'reviewer' && result.data?._id) {
                                localStorage.setItem('reviewerId', result.data._id);
                            }
                            
                            // User already has role - go to dashboard
                            console.log('‚Üí Redirecting to dashboard');
                            window.location.href = 'index.html';
                            return;
                        } else {
                            // No role found - show role selection
                            console.log('‚Üí No role found, showing role selection');
                            break;
                        }
                    } else if (roleCheckAttempts < maxAttempts) {
                        // Wait and retry
                        console.log('‚è≥ Waiting before retry...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                } catch (error) {
                    console.error(`Role check attempt ${roleCheckAttempts} error:`, error);
                    if (roleCheckAttempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
            
            console.log('‚úì Role selection ready');

            // Owner role handler
            document.getElementById('ownerCard').addEventListener('click', async () => {
                console.log('üë§ Owner role selected');
                
                const ownerBtn = document.querySelector('#ownerCard .btn-primary');
                ownerBtn.disabled = true;
                ownerBtn.textContent = 'Setting up...';
                
                try {
                    // ‚úÖ Call backend to persist owner role
                    console.log('Calling set-owner-role API...');
                    const response = await fetch(`${API_URL}/user/set-owner-role`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    console.log('Set owner role result:', result);
                    
                    if (!result.success) {
                        // Check if error is because role already set
                        if (result.error?.includes('already set')) {
                            console.log('Role already set, continuing...');
                        } else {
                            throw new Error(result.error || 'Failed to set role');
                        }
                    }
                    
                    localStorage.setItem('userRole', 'owner');
                    sessionStorage.setItem('roleJustSelected', 'true');
                    sessionStorage.removeItem('justVerified');
                    
                    ownerBtn.textContent = 'Redirecting...';
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    window.location.href = 'index.html';
                    
                } catch (error) {
                    console.error('‚ùå Error setting owner role:', error);
                    alert('Failed to set role: ' + error.message + '\n\nPlease try again or contact support.');
                    
                    ownerBtn.disabled = false;
                    ownerBtn.textContent = 'I\'m a Project Owner';
                }
            });

            // Reviewer role handler
            document.getElementById('reviewerCard').addEventListener('click', async () => {
                console.log('‚≠ê Reviewer role selected');
                
                const reviewerBtn = document.querySelector('#reviewerCard .btn-primary');
                reviewerBtn.disabled = true;
                reviewerBtn.textContent = 'Redirecting...';
                
                localStorage.setItem('userRole', 'reviewer');
                sessionStorage.setItem('roleJustSelected', 'true');
                sessionStorage.removeItem('justVerified');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                window.location.href = 'create-reviewer.html';
            });
        });
    </script>
</body>
</html>