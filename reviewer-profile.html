<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviewer Profile - HelpMarq</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div>
                    <h1>HelpMarq</h1>
                    <p class="tagline">Expert insights. Accessible pricing.</p>
                </div>
                <div>
                    <a href="index.html" class="btn-secondary btn-small">‚Üê Back to Dashboard</a>
                    <div id="user-button-container" style="display: inline-block; margin-left: 1rem;"></div>
                </div>
            </div>
        </header>

        <section class="section">
            <div id="profileContent" class="loading">Loading profile</div>
        </section>

        <section class="section">
            <h2>Review History</h2>
            <div id="reviewHistory" class="loading">Loading reviews</div>
        </section>
    </div>

    <script 
        async 
        crossorigin="anonymous" 
        data-clerk-publishable-key="pk_test_Y29ycmVjdC1zdGlua2J1Zy05OS5jbGVyay5hY2NvdW50cy5kZXYk"
        onload="window.Clerk.load()"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@4/dist/clerk.browser.js"
    ></script>

    <script>
        const API_URL = window.location.hostname === 'localhost'
    ? 'http://localhost:3000/api'
    : 'https://helpmarq-backend.onrender.com/api';
        
        window.addEventListener('load', async () => {
            if (!window.Clerk) {
                console.error('Clerk failed to load');
                return;
            }
            
            await window.Clerk.load();
            
            if (!window.Clerk.user) {
                window.location.href = '/login.html';
                return;
            }

            // Mount user button
            window.Clerk.mountUserButton(document.getElementById('user-button-container'), {
                afterSignOutUrl: '/login.html'
            });

            // Get reviewer ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const reviewerId = urlParams.get('id');

            if (!reviewerId) {
                document.getElementById('profileContent').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-title">Invalid Profile</div></div>';
                return;
            }

            await loadReviewerProfile(reviewerId);
            await loadReviewHistory(reviewerId);
        });

        async function loadReviewerProfile(reviewerId) {
            try {
                const response = await fetch(`${API_URL}/reviewers/${reviewerId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const reviewer = result.data;
                const profileContent = document.getElementById('profileContent');

                profileContent.innerHTML = `
                    <div class="reviewer-profile">
                        <div class="profile-header">
                            <div>
                                <h2>${escapeHtml(reviewer.username)}</h2>
                                <p style="color: var(--neutral-mid); margin-top: 0.5rem;">${escapeHtml(reviewer.email)}</p>
                            </div>
                            <div class="level-badge">
                                <div style="font-size: 48px; font-weight: 700; color: var(--primary-blue);">
                                    ${reviewer.level}
                                </div>
                                <div style="color: var(--neutral-mid); font-size: 14px;">Level</div>
                            </div>
                        </div>

                        <div class="profile-stats">
                            <div class="stat-box">
                                <div class="stat-value">${reviewer.xp}</div>
                                <div class="stat-label">Total XP</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${reviewer.totalReviews}</div>
                                <div class="stat-label">Reviews</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${reviewer.averageRating.toFixed(1)} ‚òÖ</div>
                                <div class="stat-label">Average Rating</div>
                            </div>
                        </div>

                        ${reviewer.bio ? `
                            <div class="profile-bio">
                                <h3>About</h3>
                                <p>${escapeHtml(reviewer.bio)}</p>
                            </div>
                        ` : ''}

                        <div class="profile-joined">
                            <p>Member since ${new Date(reviewer.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('profileContent').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-title">Error loading profile</div></div>';
            }
        }

        async function loadReviewHistory(reviewerId) {
            try {
                const response = await fetch(`${API_URL}/feedback/reviewer/${reviewerId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const reviews = result.data;
                const historyContainer = document.getElementById('reviewHistory');

                if (reviews.length === 0) {
                    historyContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">üí¨</div><div class="empty-title">No reviews yet</div></div>';
                    return;
                }

                historyContainer.innerHTML = '';

                reviews.forEach(review => {
                    const card = document.createElement('div');
                    card.className = 'feedback-card';

                    const date = new Date(review.submittedAt).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    card.innerHTML = `
                        <div class="feedback-header">
                            <h4>${escapeHtml(review.projectId.title)}</h4>
                            <span class="feedback-date">${date}</span>
                        </div>
                        <div class="feedback-text">
                            <p>${escapeHtml(review.feedbackText)}</p>
                        </div>
                        ${review.isRated ? `
                            <div class="feedback-rating">
                                <strong>Rating:</strong> ${'‚òÖ'.repeat(review.ownerRating)}${'‚òÜ'.repeat(5 - review.ownerRating)}
                                <span class="xp-badge">+${review.xpAwarded} XP</span>
                            </div>
                        ` : '<p style="color: var(--neutral-mid); font-size: 14px;">Awaiting rating from owner</p>'}
                    `;

                    historyContainer.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading review history:', error);
                document.getElementById('reviewHistory').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-title">Error loading reviews</div></div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>